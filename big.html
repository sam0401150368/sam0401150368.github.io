<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ÂΩ±ÁâáÊí≠ÊîæÂô® + Âè≥ÂÅ¥Á≠ÜË®ò (ÂèØÁ∑®ËºØ)</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; background:black;
    overflow: hidden;
    font-family: "Microsoft JhengHei", Arial, sans-serif;
    color: white;
  }
  #videoPlayer {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 100vh;
    object-fit: contain;
    background: black;
    transform: scale(1.05) translateY(-6%);
    transform-origin: center center;
    z-index: 0;
    display: block;
  }
  input[type="file"] {
    position: fixed; top: 10px; left: 10px; z-index: 100;
  }
  #notesContainer {
    position: fixed;
    top: 0;
    left: calc(100vw - 400px);
    width: 400px;
    bottom: 60px;
    background: rgba(255,255,255,0.9);
    color: #333;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
    box-shadow: -3px 0 10px rgba(0,0,0,0.5);
    z-index: 10;
    overflow: hidden;
    cursor: move;
    user-select: none;
  }
  #addNoteForm {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 5px;
  }
  #addNoteForm input[type="text"] {
    flex: 1;
    padding: 6px 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    outline-offset: 2px;
  }
  #addNoteForm button {
    padding: 6px 16px;
    font-size: 14px;
    background: #4CAF50;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #addNoteForm button:hover {
    background: #45a049;
  }
  #notes {
    flex: 1;
    overflow-y: auto;
    font-size: 14px;
    background: white;
    color: black;
    border-radius: 4px;
    padding: 5px;
  }
  #notes div.note {
    display: flex;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding: 8px 0;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #notes div.note:hover {
    background-color: #e8e8e8;
  }
  #notes div.note .time {
    flex-shrink: 0;
    width: 70px;
    background-color: #ddd;
    color: #666;
    text-align: center;
    font-weight: 600;
    border-radius: 4px;
    padding: 4px 8px;
    margin-right: 10px;
  }
  #notes div.note .text {
    flex-grow: 1;
    padding-right: 10px;
  }
  #notes div.note button.deleteBtn {
    background: transparent;
    border: none;
    cursor: pointer;
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    position: relative;
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }
  #notes div.note button.deleteBtn:hover {
    opacity: 1;
  }
  #notes div.note button.deleteBtn::before, 
  #notes div.note button.deleteBtn::after {
    content: '';
    position: absolute;
    left: 9px;
    top: 4px;
    width: 2px;
    height: 12px;
    background-color: #d9534f;
  }
  #notes div.note button.deleteBtn::before {
    transform: rotate(45deg);
  }
  #notes div.note button.deleteBtn::after {
    transform: rotate(-45deg);
  }
  #notes div.note button.editBtn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #007bff;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    margin-right: 6px;
  }
  #notes div.note button.editBtn:hover {
    opacity: 1;
    text-decoration: underline;
  }
  #saveLoadBtns {
    margin-top: 6px;
    display: flex;
    gap: 10px;
  }
  #saveBtn, #loadBtn {
    flex: 1;
    padding: 6px 10px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
    color: white;
  }
  #saveBtn {
    background-color: #007bff;
  }
  #saveBtn:hover {
    background-color: #0069d9;
  }
  #loadBtn {
    background-color: #6c757d;
  }
  #loadBtn:hover {
    background-color: #5a6268;
  }
</style>
</head>
<body tabindex="0">

<input type="file" id="videoInput" accept="video/*" />
<video id="videoPlayer" autoplay controls></video>

<div id="notesContainer">
  <form id="addNoteForm">
    <input type="text" id="noteTime" placeholder="ÊôÇÈñì (Áßí/mm:ss/hh:mm:ss)" required />
    <input type="text" id="noteText" placeholder="Á≠ÜË®òÂÖßÂÆπ" required />
    <button type="submit">Êñ∞Â¢ûÁ≠ÜË®ò</button>
  </form>
  <div id="notes"></div>
  <div id="saveLoadBtns">
    <button id="saveBtn" type="button" title="‰∏ãËºâÁ≠ÜË®ò">üíæ ‰∏ãËºâÁ≠ÜË®ò</button>
    <button id="loadBtn" type="button" title="ËºâÂÖ•Á≠ÜË®òÊ™î">üìÇ ËºâÂÖ•Á≠ÜË®ò</button>
  </div>
  <input type="file" id="loadNotesFile" style="display:none" accept=".json" />
</div>

<script>
const video = document.getElementById('videoPlayer');
const input = document.getElementById('videoInput');
const notesDiv = document.getElementById('notes');
const addNoteForm = document.getElementById('addNoteForm');
const noteTimeInput = document.getElementById('noteTime');
const noteTextInput = document.getElementById('noteText');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const loadNotesFile = document.getElementById('loadNotesFile');
const notesContainer = document.getElementById('notesContainer');

let notes = [];

function renderNotes() {
  notesDiv.innerHTML = "";
  notes.sort((a,b) => a.time - b.time);
  notes.forEach((note, idx) => {
    const div = document.createElement('div');
    div.className = "note";

    div.onclick = (e) => {
      if (e.target.classList.contains('deleteBtn') || e.target.classList.contains('editBtn')) return;
      video.currentTime = note.time;
      video.play();
    };

    const timeDiv = document.createElement('div');
    timeDiv.className = "time";
    timeDiv.textContent = formatTime(note.time);

    const textDiv = document.createElement('div');
    textDiv.className = "text";
    textDiv.textContent = note.text;

    const editBtn = document.createElement('button');
    editBtn.className = "editBtn";
    editBtn.title = "Á∑®ËºØÁ≠ÜË®ò";
    editBtn.textContent = "‚úèÔ∏è";
    editBtn.onclick = (e) => {
      e.stopPropagation();
      const newText = prompt("‰øÆÊîπÁ≠ÜË®òÂÖßÂÆπÔºö", note.text);
      if (newText !== null) {
        notes[idx].text = newText.trim();
        renderNotes();
      }
    };

    const delBtn = document.createElement('button');
    delBtn.className = "deleteBtn";
    delBtn.title = "Âà™Èô§Á≠ÜË®ò";
    delBtn.onclick = (e) => {
      e.stopPropagation();
      if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Á≠ÜË®òÔºü")) {
        notes.splice(idx, 1);
        renderNotes();
      }
    };

    div.appendChild(timeDiv);
    div.appendChild(textDiv);
    div.appendChild(editBtn);
    div.appendChild(delBtn);
    notesDiv.appendChild(div);
  });
}

function formatTime(sec) {
  let h = Math.floor(sec / 3600);
  let m = Math.floor((sec % 3600) / 60);
  let s = Math.floor(sec % 60);
  if(h > 0){
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  } else {
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }
}

function parseTime(input) {
  input = input.trim();
  if(/^\d+$/.test(input)) return parseInt(input, 10);
  let parts = input.split(':').map(p => parseInt(p,10));
  if(parts.length === 2) return parts[0]*60 + parts[1];
  if(parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
  return NaN;
}

addNoteForm.onsubmit = (e) => {
  e.preventDefault();
  const t = parseTime(noteTimeInput.value);
  if(isNaN(t) || t < 0 || t > video.duration) {
    alert("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊôÇÈñì (Áßí/mm:ss/hh:mm:ss)Ôºå‰∏î‰∏çÂæóË∂ÖÈÅéÂΩ±ÁâáÈï∑Â∫¶");
    return;
  }
  const text = noteTextInput.value.trim();
  if(text.length === 0) {
    alert("Ë´ãËº∏ÂÖ•Á≠ÜË®òÂÖßÂÆπ");
    return;
  }
  notes.push({time: t, text});
  renderNotes();
  noteTimeInput.value = "";
  noteTextInput.value = "";
};

saveBtn.onclick = () => {
  const dataStr = JSON.stringify(notes, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'video_notes.json';
  a.click();
  URL.revokeObjectURL(url);
};

loadBtn.onclick = () => {
  loadNotesFile.click();
};

loadNotesFile.addEventListener('change', () => {
  if(loadNotesFile.files.length > 0){
    const file = loadNotesFile.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const loadedNotes = JSON.parse(e.target.result);
        if(Array.isArray(loadedNotes)){
          notes = loadedNotes.filter(n => typeof n.time === 'number' && typeof n.text === 'string');
          renderNotes();
        } else {
          alert("ËºâÂÖ•Á≠ÜË®òÊ†ºÂºèÈåØË™§");
        }
      } catch(e) {
        alert("ËºâÂÖ•Á≠ÜË®òÂ§±Êïó: " + e.message);
      }
    }
    reader.readAsText(file);
  }
});

input.addEventListener('change', e => {
  const file = input.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  video.src = url;
  video.play();
  document.body.focus();
});

window.addEventListener('keydown', e => {
  if(['ArrowLeft','ArrowRight',' ','f'].includes(e.key)) {
    e.preventDefault();
  }
});
window.addEventListener('keydown', e => {
  switch(e.key){
    case 'ArrowLeft':
      video.currentTime = Math.max(0, video.currentTime - 3);
      break;
    case 'ArrowRight':
      video.currentTime = Math.min(video.duration, video.currentTime + 3);
      break;
    case ' ':
      if(video.paused) video.play();
      else video.pause();
      break;
    case 'f':
      if(document.fullscreenElement) document.exitFullscreen();
      else video.requestFullscreen();
      break;
  }
});

// ‚ú® ÈªûÂΩ±ÁâáËá™ÂãïÂ°´ÂÖ•ÁõÆÂâçÊôÇÈñìÂà∞ÊôÇÈñìÊ¨Ñ‰Ωç
video.addEventListener('click', () => {
  const current = Math.floor(video.currentTime);
  noteTimeInput.value = formatTime(current);
  noteTextInput.focus();
});

// ÊãñÂãïÂäüËÉΩ
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let startLeft = 0;
let startTop = 0;

notesContainer.addEventListener('mousedown', (e) => {
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  const style = window.getComputedStyle(notesContainer);
  startLeft = parseInt(style.left, 10) || 0;
  startTop = parseInt(style.top, 10) || 0;
  e.preventDefault();
});

window.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const deltaX = e.clientX - dragStartX;
  const deltaY = e.clientY - dragStartY;
  notesContainer.style.left = (startLeft + deltaX) + 'px';
  notesContainer.style.top = (startTop + deltaY) + 'px';
});

window.addEventListener('mouseup', () => {
  isDragging = false;
});

renderNotes();
</script>
</body>
</html>
